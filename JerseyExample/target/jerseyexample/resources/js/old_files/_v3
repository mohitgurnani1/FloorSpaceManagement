var sampleInput = {
  "layoutId": 1,
  "minimum_x": 0,
  "maximum_x": 19,
  "minimum_y": 0,
  "maximum_y": 23,
  "desks": [
  {
    "deskId": 38,
    "x": 10,
    "y": 12,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 39,
    "x": 10,
    "y": 14,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 40,
    "x": 10,
    "y": 16,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 10909000,
    "x": 4,
    "y": 19,
    "width": 3,
    "height": 3,
    "brid": ""
  },
  {
    "deskId": 24,
    "x": 7,
    "y": 12,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 25,
    "x": 7,
    "y": 14,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 26,
    "x": 7,
    "y": 16,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 35,
    "x": 8,
    "y": 12,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 36,
    "x": 8,
    "y": 14,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 37,
    "x": 8,
    "y": 16,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 1,
    "x": 1,
    "y": 3,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 2,
    "x": 2,
    "y": 3,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 3,
    "x": 3,
    "y": 3,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 4,
    "x": 4,
    "y": 3,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 5,
    "x": 5,
    "y": 3,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 6,
    "x": 1,
    "y": 6,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 7,
    "x": 2,
    "y": 6,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 8,
    "x": 3,
    "y": 6,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 9,
    "x": 4,
    "y": 6,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 10,
    "x": 5,
    "y": 6,
    "width": 1,
    "height": 2,
    "brid": ""
  },
  {
    "deskId": 16,
    "x": 10,
    "y": 3,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 18,
    "x": 11,
    "y": 3,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 20,
    "x": 12,
    "y": 3,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 22,
    "x": 13,
    "y": 3,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 17,
    "x": 10,
    "y": 4,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 19,
    "x": 11,
    "y": 4,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 21,
    "x": 12,
    "y": 4,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 23,
    "x": 13,
    "y": 4,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 27,
    "x": 10,
    "y": 6,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 28,
    "x": 11,
    "y": 6,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 29,
    "x": 12,
    "y": 6,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 30,
    "x": 13,
    "y": 6,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 31,
    "x": 10,
    "y": 7,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 32,
    "x": 11,
    "y": 7,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 33,
    "x": 12,
    "y": 7,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 34,
    "x": 13,
    "y": 7,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 11,
    "x": 1,
    "y": 9,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 12,
    "x": 2,
    "y": 9,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 13,
    "x": 3,
    "y": 9,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 14,
    "x": 4,
    "y": 9,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 15,
    "x": 5,
    "y": 9,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 41,
    "x": 13,
    "y": 17,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 42,
    "x": 14,
    "y": 17,
    "width": 1,
    "height": 1,
    "brid": ""
  },
  {
    "deskId": 43,
    "x": 15,
    "y": 17,
    "width": 1,
    "height": 1,
    "brid": ""
  }
]
};

var canvasElement = document.getElementById("workarea");
canvasElement.setAttribute("width", window.innerWidth);
canvasElement.setAttribute("height", window.innerHeight);

var canvas = new fabric.Canvas('workarea', { selection: false, backgroundColor: "#ffffff"});

function parse(input){
  var inputObj = input;
  var workarea = new Workarea(inputObj.minimum_x, inputObj.maximum_x, inputObj.minimum_y, inputObj.maximum_y);
  inputObj.desks.forEach(function(desk){
    workarea.createDesk(desk);
  });
}

function initialise(){

  $.ajax({url: GET_LAYOUT_URL, success: function(result){

    var inputObj = result;
    var workarea = new Workarea(inputObj.minimum_x, inputObj.maximum_x, inputObj.minimum_y, inputObj.maximum_y);
    $.ajax({url: GET_DESK_URL, success: function(result){
      var deskList = result;
      deskList.forEach(function(desk){
        workarea.createDesk(desk);
      });
    }})
  },
  error: function(error, statusText){
    alert(statusText);
  }});
}

function Workarea(minX, maxX, minY, maxY){
  this.minX = minX;
  this.minY = minY;
  this.maxX = maxX;
  this.maxY = maxY;
  this.height = maxY - minY;
  this.width = maxX - minY;
  this.canvas = canvas;
  this.gridSize = ((window.innerHeight/(this.height))<(window.innerWidth/(this.width))?(window.innerHeight/(this.height))+3:(window.innerWidth/(this.width))+3);
  this.xGridSize = window.innerWidth/this.width-3;
  this.yGridSize = window.innerHeight/this.height-3;
}
  
  Workarea.prototype.createDesk = function(desk){
    var that = this;
    that.canvas.add(new fabric.Rect({ 
      left: (desk.x)*that.xGridSize+chairDef.paddingRatio*that.gridSize, 
      top: (desk.y)*that.yGridSize+chairDef.paddingRatio*that.gridSize,  
      width: (desk.width)*that.xGridSize-2*chairDef.paddingRatio*that.gridSize,
      height: (desk.height)*that.yGridSize-2*chairDef.paddingRatio*that.gridSize,
      stroke: '#000000',
      fill: 'transperant',
      rx: chairDef.borderRadiusRatio*that.gridSize,
      ry: chairDef.borderRadiusRatio*that.gridSize,
      originX: 'left',
      originY: 'top',
      deskId: desk.deskId,
      brid: desk.brid,
      hasControls: false,
      entity: "desk",
      selectable: false,
      hoverCursor: "crosshair"
    }));
  };



  var tooltipSpan = document.getElementById('tooltip-span');
  var deskInfo = document.getElementById('desk-info');
  var employeeInfo = document.getElementById('employee-info');


 canvas.on('mouse:over', function(e) {
    console.log(e.target);
    if(e.target.entity == "desk"){
      var element = e.target;
      e.target.set({fill:"#ccc"})
      var style = "display:block; position:fixed; overflow:hidden; background-color: black; color:white; padding:10px; box-shadow: 1px 1px 2px grey; border-radius:5px"
      tooltipSpan.setAttribute("style", style);
      deskInfo.innerHTML = "Desk Id: " + e.target.deskId;
      
      if(e.target.brid == ""){
        deskInfo.innerHTML += "<br>Not Alloted";
      }
      else{
        employeeInfo.innerHTML = "Loading..."
      
        $.ajax({url: GET_EMPLOYEE_URL, success: function(result){
          employeeInfo.innerHTML = "BRID: " + result.brid + "<br>Employee Name: " + result.name + "<br>Date of Occupancy: " + result.doo + "<br>Team: " + result.team;
        },
        error: function(error){
          employeeInfo.innerHTML="Error Fetching Employee Information";
        }});
      }
      canvas.renderAll();
    }
  });

  canvas.on('mouse:out', function(e) {
    tooltipSpan.setAttribute("style", "display:none;")
    e.target.set({fill:"transperant"})
    canvas.renderAll();
  });

  window.onmousemove = function (e) {
    var x = e.clientX,
        y = e.clientY;
    tooltipSpan.style.top = (y + 20) + 'px';
    tooltipSpan.style.left = (x + 20) + 'px';
}; 

initialise();
//parse(sampleInput);